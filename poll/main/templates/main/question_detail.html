{% extends "base.html" %}

{% block title %}Question Detail{% endblock %}

{% block content %}
<h1 class="mb-4">Question Detail</h1>
<div class="mb-3">
  <strong>Question text:</strong>
  <pre>{{ question.text }}</pre>
</div>
<div class="mb-3">
  <strong>Number of question variations:</strong> {{ num_variations }}
</div>
<div class="mb-3">
  <strong>Total LLM queries:</strong> {{ total_queries }}
</div>

<h2 class="mt-5">Batches</h2>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>Batch ID</th>
      <th>Status</th>
      <th>Created</th>
      <th>Updated</th>
    </tr>
  </thead>
  <tbody>
    {% for batch in batches %}
    <tr>
      <td>{{ batch.batch_id }}</td>
      <td>{{ batch.status }}</td>
      <td>{{ batch.created_at }}</td>
      <td>{{ batch.updated_at }}</td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="4" class="text-center">No batches.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h2 class="mt-5">Answers</h2>
{% if has_answers %}
<p>
  <a class="btn btn-primary" href="{% url 'polls:question_answers_csv' question.uuid %}">Download CSV</a>
</p>

<h2 class="mt-5">Big-picture preference counts</h2>
<canvas id="preferenceChart" height="120"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
  const prefData = {{ preference_counts_json|safe }};
  const ctx = document.getElementById('preferenceChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(prefData),
      datasets: [{
        label: 'Preference count',
        data: Object.values(prefData),
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });
</script>
{% else %}
<p>No answers.</p>
{% endif %}
{% endblock %}
